<?php
$pgconnectstr = "host=127.0.0.1 port=5432 dbname=KMMAR22 user=postgres password=1q2w3e4r5t";
$patientfilter = "SELECT p.account_no, p.full_name, p.id as patient_id, p.phonogram_name, p.ideogram_name, p.birth_date::text, p.gender, '' as last_study_date, p.patient_info, nullif(p.patient_details->>'pat_comments', '') as pat_comments, p.stat, p.reception_dt, p.urgency, p.has_photo, p.photo_uploaded_dt, false as is_animal, p.reception_no, p.last_edit_dt FROM patients p";
$studyfilter = "select studies.id as study_id, studies.patient_id, studies.study_uid, '' as character_set, patients.account_no, patients.full_name, patients.phonogram_name, patients.ideogram_name, patients.birth_date::text, patients.gender,'' as last_study_date,patient_info->'owner_full_name' as owner_full_name, patient_info->'owner_phonogram_name' as owner_phonogram_name,patient_info->'owner_ideogram_name' as owner_ideogram_name, patient_info->'species' as species,patient_info->'bleed' as bleed, false as is_animal, studies.patient_age, studies.accession_no, studies.study_dt, studies.cpt_codes, studies.study_description, studies.orientation, studies.body_part, studies.modalities from studies inner join patients on studies.patient_id = patients.id and studies.no_of_instances > 0 and studies.no_of_series > 0 and study_details is not null";
$dicomstudyfilter = "WITH max_ins AS (SELECT study_id , max(study_series_instances.id) AS max_ins_id FROM study_series_instances GROUP BY study_id),Study_status_UNR AS (SELECT status_desc FROM study_status WHERE status_code = 'UNR') SELECT studies.id as study_id, studies.patient_id, studies.study_uid, '' as character_set, patients.account_no, patients.full_name, patients.phonogram_name, patients.ideogram_name, patients.birth_date::text, patients.gender,'' as last_study_date,patient_info->'owner_full_name' as owner_full_name, patient_info->'owner_phonogram_name' as owner_phonogram_name,patient_info->'owner_ideogram_name' as owner_ideogram_name, patient_info->'species' as species,patient_info->'bleed' as bleed, false as is_animal, studies.patient_age, studies.accession_no, studies.study_dt, studies.cpt_codes, studies.study_description, studies.orientation, studies.body_part, studies.modalities, studies.study_details, studies.no_of_series, studies.no_of_instances FROM max_ins INNER JOIN studies ON studies.id = max_ins.study_id INNER JOIN patients ON (studies.patient_id = patients.id AND studies.no_of_instances > 0 AND studies.no_of_series > 0) %s order by studies.no_of_instances desc limit %d";
$studyviewerinfo = "SELECT coalesce(m.modality_code, '') AS modality, studies.study_dt, to_char(Timezone(facilities.time_zone, study_dt), 'YYYYMMDD') as study_date, to_char(Timezone(facilities.time_zone, study_dt), 'HH24MISS') as study_time, studies.id, studies.dicom_study_id, studies.study_uid, studies.study_uid_received, studies.study_guid, studies.accession_no, studies.patient_id, studies.order_id, studies.referring_physician_id, studies.reading_physician_id, studies.institution_id, studies.study_status, studies.duration, studies.procedure_id, studies.study_description, studies.body_part, studies.department, studies.reason_for_study, studies.cpt_codes, studies.orientation, studies.is_mammo_study, studies.stat_level, studies.notes, studies.study_received_dt, studies.study_created_dt, studies.last_edited_by, studies.last_edited_dt, studies.application_entity_id, studies.modality_id, studies.facility_id, studies.has_deleted, studies.deleted_dt, studies.patient_age, studies.study_details, m.modalities_in_study, has_priors(studies.id, studies.patient_id), studies.priority, studies.no_of_series, studies.no_of_instances, studies.annotations, studies.dicom_status, studies.company_id, studies.tat_level, studies.viewer_series_link_info, studies.viewer_stack_link_info, studies.cpt_code_id, studies.institution, studies.row_version, studies.status_last_changed_dt, studies.linked_study_id, studies.provider_group_id, studies.study_started, studies.study_unread_dt, studies.approved_dt, studies.has_locked, studies.locked_dt, studies.unlocked_dt, studies.locked_by, studies.signed_ref_doctor_dt, studies.dictation_started, studies.has_unread_dicoms, studies.status_last_changed_by, studies.dcm_patient_id, studies.study_info :: json AS study_info, studies.study_attributes, coalesce(patients.full_name, study_info -> 'full_name') AS full_name, substring(patients.gender, 1, 1) AS gender, patients.birth_date :: text AS birth_date, patients.account_no, patients.patient_details,(SELECT array_to_json(array_agg(keys)) FROM (SELECT study_series_instance_id AS instance_id, sop_iuid AS instance_uid, frame_no FROM study_key_instances WHERE study_id = studies.id) AS keys) AS key_images FROM studies left join patients ON studies.patient_id = patients.id join get_study_modality_info(studies.id) m ON true join facilities ON facilities.id = studies.facility_id";
$stackviewerinfo = "SELECT study_stacks.id,study_stacks.stack_uid,study_stacks.series_id,study_stacks.study_id,study_stacks.series_uid,study_stacks.instance_uid,study_stacks.time_echo,study_stacks.series_time,study_stacks.series_no,study_stacks.modifier,study_stacks.stack_props,study_stacks.modality,COALESCE(( study_stacks.stack_props ->> 'stack_order' ) :: INT, study_stacks.series_no, 0) AS stack_order FROM study_stacks WHERE study_stacks.study_id = %d ORDER BY COALESCE(( stack_props ->> 'stack_order' ) :: INT, series_no, 0), id";
$instanceviewerinfo = "SELECT study_series_instances.id, study_series_instances.instance_attributes:: json As instance_attributes, study_series_instances.instance_info, (select root_directory from file_stores where file_stores.id = study_series_instances.file_store_id) as root_directory, file_path FROM	study_series_instances WHERE study_series_instances.stack_id = %d";
?>